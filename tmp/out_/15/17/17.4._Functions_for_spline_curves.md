## 17.4 スプライン曲線のための関数

これらのフラスタム関数は、アプリケーションがDCMにスプライン図形を追加する場合にのみ必要です。つまり、add_spline_gが呼び出される場合です。

### 17.4.1 DCM_spline_update – スプラインのプロパティの更新を許可する

void DCM_spline_update(void* ag, unsigned int m);

この関数は、評価中にアプリケーションが特定のスプラインデータを変更することを可能にします。
スプラインへのアプリケーションポインタ(ag)と、変更できるデータを示すビットのマスク(m)が引数として渡されます。
他のデータを変更しようとする試みは無視されます。

必要に応じて、アプリケーションは新しいスプラインデータをupdate_spline関数またはreplace_spline関数で呼び出すべきです。

この関数は、以下のスプラインの振る舞いを実装するために使用されます：

- move_and_evaluate – 剛体または固定スプラインのみ

DCM_spline_updateは、剛体または固定スプラインが変更される図形のリストに含まれている場合（DCM_NULL変換で）move_and_evaluate関数の中で1回呼び出されます。

マスク(m)には、変更可能なスプラインのすべてのプロパティが含まれます。
move_and_evaluate中に変更できない一部のプロパティがあります：

- DCM_BS_RIGIDITY – スプラインは解決中に剛体（または固定）のままでなければなりません。
- DCM_BS_INTERP_STATUSES、DCM_BS_INTERP_CON_BAL、DCM_BS_INTERP_D_STATUSES – これらのフィールドは出力専用です。

スプラインを変更するには、アプリケーションはreplace_spline関数またはupdate_spline関数のいずれかを呼び出す必要があります。
変更がadd_spline_g呼び出しで提供された初期スプラインマスクの修正と追加に限定されている場合、通常はupdate_spline関数を使用して特定のプロパティを更新することができます。
制御点の変更、制御点から補間点への定義の変更、スプラインの解決モードの変更など、より基本的な変更の場合は、replace_spline関数を使用する必要があります。
[16.6.6 replace_spline - スプライン曲線の定義の変更](16.6._Spline_functions.md)を参照してください。

この文脈では、undo_evaluation関数はスプラインに対して行われた変更を元に戻すためにDCM_spline_updateを呼び出しません。
ただし、必要に応じて、undo_evaluationが完了した後にupdate_spline関数またはreplace_spline関数を呼び出すことで、そのような変更を行うことができます。

- 再パラメータ化 – 補間依存スプラインのみ

DCM_spline_updateは、パラメータ化フィールドにDCM_BS_PARAMETERISATION_VARIABLEが含まれる補間依存スプラインの解決中に複数回呼び出されます。
マスクはinterp_parameters配列とknot_vector配列を問い合わせるために設定されます（これらはadd_spline_gへの元の呼び出しで指定された場合）。
パラメータ化を再計算するために、アプリケーションは現在の補間点の位置をクエリする必要があります。
これには、マスクをDCM_BS_INTERP_VECTORSに設定してenquire_splineを呼び出すことが最も便利な方法です。
より効率の悪い代替方法として、各点に対してtransformを呼び出すこともできます。
アプリケーションはこの情報を使用してスプラインの再パラメータ化のみを行い、この時点では点の位置を更新しないようにする必要があります。

アプリケーションはスプラインの開始または終了パラメータを変更してはなりません。

固定パラメータ化（DCM_BS_PARAMETERISATION_FIXED）スプラインのパラメータ化は変更できません。
DCM_BS_PARAMETERISATION_CHORD_LENGTHスプラインのパラメータ化は、DCM_spline_updateを呼び出すことなくDCMによって自動的に更新されます。

- スプラインのプロパティの変更 – 有理スプライン

DCM_spline_updateは、各評価の開始時に有理スプラインのcp_weightsを問い合わせるために呼び出されます。
これにより、アプリケーションは新しい値を使用してDCMのupdate_spline関数を呼び出すことで、各制御点の重みを変更する機会が与えられます。
この関数により、アプリケーションは新しい値を使用してre_evaluateを繰り返し呼び出すことで、重みの動的な変更を実装することができます。
たとえば、Analyseでは、この関数を使用して制御点の重みのドラッグを実装しています。

- スプラインのプロパティの変更 - 補間条件

DCM_spline_updateは、補間条件を持つスプラインの各評価の開始時にinterp_vectorを問い合わせるために呼び出されます。
これにより、アプリケーションは新しい条件値を使用してDCMのupdate_spline関数を呼び出すことで、補間条件を変更する機会が与えられます。
アプリケーションは、ユーザーが画面上でカーソルをドラッグするといった場合に、新しい値を使用してre_evaluateを繰り返し呼び出すことで、補間条件の動的な変更を実装することができます。

単一スケーラブルおよびバイスケーラブルスプライン曲線では、評価中にDCM_bs_data構造で指定されたスケーリング方向を変更することは許可されません。スケーリング中心は別のFrustum関数を通じて問い合わせられます（[17.12.2 DCM_scaling_centre – スケーラブルセット、スプライン、円錐曲線のソリューション制御](17.12._Miscellaneous_functions.md)を参照）

DCM_spline_updateはオプションの関数です。アプリケーションが値を変更する必要がない場合は、この関数を登録する必要はありません。

### 17.4.2 DCM_spline_changed - スプラインが変更された場合の出力

void DCM_spline_changed( void* ag );

モデルが評価される際に、スプラインを定義する制御点が移動した場合に呼び出されます。

スプライン曲線の剛体変換の場合、この関数はスプライン曲線が柔軟な、スケーラブルな、単一スケーラブルな、または二重スケーラブルなスプラインである場合にのみ呼び出されます。
この場合、DCM_transformはスプラインg_node自体では呼び出されません。
ただし、DCMは各制御（または補間）点g_nodeを介してDCM_transform関数を使用して変換を出力します。

なお、この関数は剛体スプラインには呼び出されません。
剛体スプラインがDCMによって移動される場合、制御点や補間点のg_nodeではなく、スプラインg_nodeのためにDCM_transform関数が呼び出されます。

### 17.4.3 DCM_spline_status - スプラインの状態変更を通知する

void DCM_spline_status(void* ag);

この関数は、DCMによってinterp_d_statusesのいずれかが変更された場合に呼び出されます。
アプリケーションは、新しいステータスコードが必要な場合には、適切なビットマスクを使用してenquire_spline関数を呼び出す必要があります。
