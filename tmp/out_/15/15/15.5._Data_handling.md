## 15.5 データの処理

アプリケーションは、情報が常にFrustumのルーチンを介してアクセスされ、DCMが使用するのはポインタだけであるため、任意の種類のデータ構造を定義することができます。
ただし、アプリケーションのデータ構造には、DCMが必要とする情報が含まれている必要があります。

アプリケーションは、DCMに宣言したデータを保持する必要があります。
また、DCMからは回復できないため、DCMノードと寸法設定の接続性の記録を保持する必要があります。

### 15.5.1 アプリケーション参照（アプリケーションポインタ）

2D DCMにロードされるほとんどのデータについては、時間（DCMではノード）が作成される際にアプリケーション参照値が提供されることが期待されています。
この参照は、(void\*)型を使用して渡されるため、オブジェクトへのポインタを格納することができます。
ただし、ポインタと同じサイズの任意のデータを格納するためにも使用することができます。

この参照は、データアイテムに特定のフラスタム照会が行われる際に、アプリケーションが呼び出しの文脈を識別できるように渡されます。
フラスタム関数も(void\*)型を使用します。

アプリケーション参照の値は、ヌルポインタとの混同を防ぐため、0以外の任意の値を取ることができます。顧客は値0の使用を避けることをお勧めします。
一部のDCMノードは、フラスタム関数が必要ないもの（静的な定数項を持つ剛体線形方程式など）を含め、アプリケーション参照が0のノードとして作成することができます。

一般的に、関連するノードを識別するための唯一の文脈が参照値0の場合、DCMはフラスタム関数を呼び出しません。これにより、そのようなノードを追加しようとする試みが多く拒否されます（例：DCM\_g\_identifyなどの必須フラスタム関数が利用できないため）。ただし、アプリケーション参照が0である場合には、DCMノードポインタとアプリケーション参照の両方を提供するDCM\_erased\_nodeなどの関数が呼び出されます。

### 15.5.2 図形と寸法データの保存

以下のセクションでは、寸法と図形のためのアプリケーションデータ構造の要件について説明します。

#### 15.5.2.1 線の方向

DCMは、角度寸法の解決方法と、寸法が測定される線のどちら側（すなわち、どちらの手性）かを決定するために、線の方向を使用します。したがって、アプリケーションは、DCMからの要求がある場合にのみ、線の方向を変更する必要があります。

これによる重要な結果は、アプリケーションが境界線の始点と終点を使用してその方向を定義することができないということです。特殊な場合である点が重なっている場合を除いて、DCMは点を移動させて入れ替えることが可能です。

#### 15.5.2.2 データの消去

DCMからノードが消去されると、アプリケーションによって追加された他のノードも削除されることがある内部のクリーンアップが行われます。
これの最も単純な例は、g\_nodeが消去されると、それに接続されたd\_nodeも消去されることです。
アプリケーションを支援するために、DCMはフラスタム関数を呼び出して、DCM内でノードが消去されたことをアプリケーションに通知します。
この関数は、ノードが明示的に消去関数で呼び出されたかどうかに関係なく、ノードが消去されるたびに呼び出されます。

アプリケーションは、元の消去関数の呼び出し後に消去する必要があるアプリケーションオブジェクトのリストを作成するために、この関数を使用することができます。

#### 15.5.2.3 線上の位置の重要性

線は、DCMにとって、線上の位置を示すベクトルと方向を示すベクトルとして表されます。
ほとんどの場合、この定義は冗長であり、アプリケーションは線上のどこでも位置を返し、方向ベクトルの長さを変えてもDCMの振る舞いは変わりません。

ただし、位置を変更すると、ジオメトリが不完全な場合には違いが生じることがあります。
このような場合の特定のケースは、DCMが制約を満たすために線を回転させる必要がある場合です。
この場合、制約が2本の線に関連している場合、DCMは線を交差点を中心に回転させることができます（ただし、これがサイズボックス内にある場合に限ります）。
ただし、線の位置に影響を与える制約がなく、DCMが他の適切な位置を検出できない場合、DCMはアプリケーションが返す位置を中心に線を回転させることを選択する場合があります。

Analyseでは、境界付きの線は、境界のない線と2つの点から構成されます。
線上の位置は、常に2つの点の中間になるように調整されます。
現在の位置は、Graphics... Base pointsコマンドを使用して確認することができます。

#### 15.5.2.4 ヘルプポイントとヘルプパラメータ

アプリケーションは、寸法や円や楕円への拘束にヘルプポイントを保存する必要があります。また、パラメトリックへの寸法や拘束にはヘルプパラメータが必要です。
なお、一部の場合、例えば2つの円の間の距離寸法の場合、2つのヘルプポイントが必要です。

ヘルプポイントを使用しない寸法や拘束のデータ構造を実装することも可能ですが、使用することが推奨されています。
ヘルプポイントがない場合、円への寸法は最小距離寸法のみであり、方向付き距離寸法は使用できません。
詳細は、セクション[4.1.2.1 最小距離寸法](4.1._Dimensions_with_a_value.md)を参照してください。

#### 15.5.2.5 有界図形

DCMは、無限に広がる直線、円、楕円のみをサポートしています。
しかし、ほとんどのアプリケーションでは、有界図形を表現する必要があります。
有界曲線は、無限に広がる図形と始点と終点を作成し、これらの点を無限に広がる図形と重なるように制約することで、DCMで表現することができます。
アプリケーションは、点と無限に広がる図形の関係を記録する必要があります。
閉じたループなどのより複雑なデータ構造も構築することができます。
スケッチに必要な上位エンティティを管理するための別のコンポーネント、Profile Geometry Manager（D-Cubed PGM）も利用できることに注意してください。

#### 15.5.2.6 3Dデータの操作

DCMのデータは常にアプリケーションが管理しているため、3次元空間の2次元の部分集合で作業することが可能です。
アプリケーションはデータを2Dに変換し、Frustumルーチンで再び3Dに戻します。

投影面の法線に平行な方向を持つ直線は、点として表現することもできますが、これはビューが変更された場合に変更する必要があります。
[3.3 Geometry directions](3.3._Geometry_directions.md)のセクションのコメントを参照してください。
同様に、2Dに投影された3Dパラメトリック曲線には不連続点が含まれる場合があります。

### 15.5.3 キャッシュされたフラスタム呼び出し

DCMのデフォルトの動作は、フラスタムへの呼び出し回数を減らすために、データを内部的に保存することです。
効率的なフラスタムを持つアプリケーションで、DCMが使用するメモリ量を最小限に抑えたい場合は、set_option DCM関数を使用してジオメトリの位置のキャッシュをオフにすることができます。

### 15.5.4 DCMから独立してデータを変更する

アプリケーションは、DCMの呼び出し間でのみ通常行われることが多いが、ジオメトリを変換し、寸法データの値を変更することができます。 
また、方程式の定数や係数の値を変更することも可能です。 
ただし、エンティティのタイプは変更できず、アプリケーションはこれを行うためにエンティティを削除して再作成する必要があります（例えば、直線が円弧に「曲がる」場合など）。

セクション[2.5._Evaluating_the_model.md](2.5._Evaluating_the_model.md)を参照してください。

### 15.5.5 履歴ベースのシステムでDCMを使用する方法

DCMには、モデルが変更された後にシーケンスで再生成される履歴ベースのシステム内で使用するための機能が含まれています。
以下の機能がこの使用法に関連しています：

- 固定および凍結した図形 - 通常、アプリケーションはユーザーにモデルの構築と、その後DCMを使用してモデルの面にプロファイルをスケッチすることを許可します。
この場合、DCMがそれを移動しないようにする必要がある場合、図形を固定することができます。
詳細は、[6. 固定、凍結、自由な図形](6._Fixed,_Frozen_and_Free_Geometry.md)を参照してください。
- move\_and\_evaluate関数 - この関数は、DCMとは独立して移動された場合にスケッチに使用される固定された図形を更新するために使用することができます。
詳細は、[16.8.3 move\_and\_evaluate - キラリティを保持して評価する](16.8._Model_evaluation.md)を参照してください。

### 15.5.6 エラーチェック

DCMおよびFrustumのインターフェースのいずれにおいても、引数のチェックはほとんど行われません。なぜなら、それはアプリケーション独自のチェックと重複する可能性があるためです。
したがって、正しい引数が渡されることを確認することが重要です。
エラーが疑われる場合は、journal関数を使用してDCMおよびFrustum関数へのすべての呼び出しの詳細を書き出すことができます。

#### 15.5.6.1 例外処理

2D DCMライブラリは意図的に例外をスローしないため、ライブラリは例外をキャッチしようとせず、代わりに呼び出し元のアプリケーションコードに例外を渡すことを好む。DCMを介して呼び出されるアプリケーションコードが例外をthrow()することもあります。また、DCMコードでは、debug\_xmitやjournal\_by\_nameでファイルにアクセスしようとする場合など、例外をthrow()する可能性のあるシステムコールを行うことがあります。

アプリケーションコードはこれらの例外をキャッチして処理することができます。Frustumの例外の場合、これらはFrustum関数が返る前にキャッチするのが最善です。これにより、DCMの操作が影響を受けずに続行できる場合があります。ただし、そうでない場合は、DCMのコールスタックをアンワインドさせ、DCMを呼び出した関数で例外をキャッチすることができます。その場合、DCMは正常な状態にはならず、さらなるDCM操作を行う前にインスタンスを削除して再作成する必要があります。

DCMインスタンスはC++のデストラクタを介して削除されることに注意してください。非空のDCMが削除される場合、モデルデータの消去をアプリケーションに通知するためにFrustum関数を呼び出すことができます（つまり、DCM\_erased\_node\_function）。一般的に、C++ではデストラクタが例外をスローしないようにすることが推奨されており、C++11からはこれが標準のデフォルト動作となっています。ただし、メインのDCMデストラクタの場合、これは適切なデフォルトではありません。なぜなら、顧客のフラスタム関数が例外をスローする可能性があるからです。DCMデストラクタからのコールバックがないことを保証するために、最初にerase\_all関数を呼び出して消去するノードが残らないようにすることができます。

DCMデストラクタは、呼び出し元のアプリケーションに顧客の例外を返すために使用されます。したがって、C++デストラクタが例外をスローすることを許可するコンパイラオプションが指定されています。

この動作はプラットフォームに大きく依存するため、WindowsプラットフォームとUnixプラットフォームでは例外の挙動に違いがあるかもしれません。将来的には、ライブラリの挙動を変更する可能性があります。

#### 15.5.6.2 割り込みと中止

DCMには割り込みを処理する機能はありません。
DCMの機能が割り込まれると、そのデータ構造は破損する可能性があります。
DCMのメモリを解放するための機能を実装していない限り、安全な操作はプログラムを停止することです。
ただし、アプリケーションはDCMコマンド[set_option](16.2._Configure_global_DCM_behaviour.md)を呼び出すことができます。
アプリケーションはこれを使用して、DCMができるだけ早く処理を停止するように要求することができます。

DCMは、メモリの割り当て要求がすべて成功することを前提としており、メモリの割り当てに失敗した場合には回復する試みは行われません。
ただし、すべてのメモリはC++のnew関数によって割り当てられます。
アプリケーションは、メモリの割り当てに失敗した場合をチェックするバージョンの標準的なnew関数を置き換えることが可能です。

### 15.5.7 インクリメンタルグラフィックス

DCMは、インクリメンタルなアプリケーションデータの更新（例：インクリメンタルグラフィックス）をサポートしています。
DCMは、FrustumルーチンDCM\_transform、DCM\_scale\_transform、DCM\_set\_radius、DCM\_set\_major\_radius、DCM\_set\_minor\_radiusを介してのみ、図形の変更を行います。
さらに、DCMは、変更された状態のジオメトリをDCM\_g\_statusを使用してアプリケーションに通知します。
アプリケーションは、これらのルーチンからの情報を使用して、適切に表示構造を更新することができます。

### 15.5.8 操作の逆転

評価の結果は順序や時間の経過に依存しないため、操作は前のDCM構造を再作成し、図形の位置をリセットすることで逆転させることができます。
DCMは、undo_evaluation関数を使用してジオメトリをリセットするために使用することができます。
この関数を使用すると、モデルを初期位置（直近の完全な評価の前の位置）または前の位置（直近の評価の前の位置）にリセットすることができます。

[16\. The DCM Interface](16._The_DCM_Interface.md)の章を参照してください。

### 15.5.9 データの保存

データは、DCMとは独立して、寸法と図形情報を保存することでアプリケーションによって保存および復元することができます。
DCMの構造は、DCMの図形と寸法ノードを再作成することで取得されます。
