## 16.9 図形のドラッグ

以下の関数は、図形のドラッグに使用されます。

### 16.9.1 dynamic\_evaluate - 未定義の図形をドラッグする

この関数は、図形ノードを変形させ、変形された図形を考慮してモデルの図形を再計算します。
これは、アプリケーションでドラッグを実装するために使用されます。

- n\_geom, gn \- 関数は変形されるDCM図形ノードの配列（gn）と、配列の長さに対応する整数（n\_geom）を取ります。

配列に含めることで、セットをドラッグすることも可能です。
- mat \- 変形はn\_geom個の変形行列の配列として与えられます。
各変形行列は、gn内の対応する図形に適用されます。
変形は、図形ベクトルに前置されます。
許容される変形の種類と行列の宣言方法については、[15.13 DCM transforms](15.13._DCM_transforms.md)のセクションで説明されています。
図形の元の位置は、この関数の連続呼び出しの最初の呼び出しの前の位置です。

ノードを移動させないようにするために、単位行列の変形を指定することも可能です。
- rad \- これは長さn\_geomの配列です。
各値は、ドラッグされる図形に適用される値を表します。
この引数は、DCM\_NULLに設定される場合もあります。
この値は、次の場合にのみ使用されます。

- 対応する図形（gn内）が円または楕円であり、対応するドラッグタイプ（dragt内）が半径の変更を意味する場合、値radは図形の新しい半径に対応します。

ゼロ半径の円はサポートされていますが、楕円の半径は現在定義されている線形解像度よりも小さい場合は適用されません。
負の半径は常に無視されます。
- 対応する図形（gn内）がオフセット曲線であり、タイプ（dragt内）がオフセット距離の変更を指定している場合、値radは新しいオフセット距離値です。
- 対応する図形（gn内）がスケーラブルセットであり、タイプ（dragt内）がスケールの変更を指定している場合、値radはセットのスケール変更の係数です。値1は変更なしを示します。
現在のメソッドでは、単一またはバイスケーラブルセットをこの方法でスケーリングすることはできません。

- dragt \- この配列も長さn\_geomです。
この配列の各エントリは、この関数とその後のこの関数の呼び出しによって対応する図形がどのように変更されるかを指定します。
可能な値は次のとおりです。

DCM\_DT\_GENERAL   \- 移動と/または回転

DCM\_DT\_TRANSLATION  \- 移動のみ

DCM\_DT\_RADIUS   \- 円の半径のみ

DCM\_DT\_MAJOR\_RADIUS \- 楕円の長半径のみ

DCM\_DT\_MINOR\_RADIUS\- 楕円の短半径のみ

DCM\_DT\_OFFSET\_DISTANCE  \- オフセット距離のみ

DCM\_DT\_SCALE\_FACTOR   \- スケーラブルセットのスケーリングのみ

円と点の場合、DCM\_DT\_GENERALとDCM\_DT\_TRANSLATIONは同じ効果があります。

最初の2つのコードでは、アプリケーションはmat内の対応する位置の図形に対して変形行列を与えることが期待されます。
他のタイプの場合、アプリケーションはrad内の対応する位置の図形に対して新しい半径値、スケーリング係数、またはオフセット距離を与えることが期待されます。
DCMは期待される情報のみを探しますので、アプリケーションが円の半径を変更することを示す場合、DCMは変形を適用しません。
- res \- 成功または失敗は、この引数の値によって示されます。可能な値は次のとおりです。

- DCM\_DRAG\_SUCCEEDED \- 操作が成功しました。
- DCM\_DRAG\_FAILED \- ドラッグに失敗しました。
この場合、DCMは依然として図形にいくつかの変更を加えているかもしれません。
アプリケーションは、次のこの関数の呼び出し前にモデルを前の位置に戻すために、関数undo\_evaluationを呼び出さなければなりません。そうしないと結果は予測できません。
したがって、ユーザーは常に現在の位置（これが許容される場合）または最後の許容される位置が表示されます。

- opt \- 指定されたすべての変換を指定された図形に適用することは常に可能ではありません。
このオプションの引数は、これらの場合に何が起こるかを制御するために使用されます。
2つの値のいずれかを取ることができます。

- DCM\_DRAG\_POSSIBLE \- これがデフォルトの動作です。
可能な限り与えられた変換のすべてを適用します。
この引数を使用すると、この関数の呼び出しは、いくつか（またはすべて）の図形が移動できなかった場合でも成功したと見なされます。
DCMがドラッグされている1つ以上の図形が過拘束または不整合であることを発見した場合にのみ、失敗と見なされます。
配列内の図形の順序は、図形が移動する優先順位の指定された順序を示します。配列内の最初の図形が最も移動しやすいです。
- DCM\_DRAG\_SPECIFIC \- すべての指定された変換を指定された図形に完全に適用できる場合にのみ、呼び出しは成功と見なされます。
図形のいくつかに自由度が制限されている場合、特定の変換のみを使用できます。

- mode \- このオプションの引数は、使用する解法のタイプを指定します。
デフォルトのモードはDCM\_MINIMUM\_MOVE\_SOLVEです。
新しい統合を実装する顧客は、モデルDCM\_LOCALISED\_SOLVEを使用することを検討してください。
可能な解法モードとその使用方法の詳細については、[2.5.6 Solution control for under-constrained geometry](2.5._Evaluating_the_model.md)のセクションを参照してください。

同じ図形がgn配列内に複数回表示されることがあります。
これにより、アプリケーションは、例えば円を移動させながら半径を変更することができます。
ノードの指定の順序は重要です。なぜなら、DCMは配列内のノードの要求された変換を、配列の後のノードよりも配列の前のノードに優先して満たそうとするからです。

この関数は、evaluateの説明で説明されているように、図形にステータスを設定しますが、未定義および適切に定義された図形のステータスコードはG\_UNDER\_DEFINEDです。

re\_evaluateと同様に、この関数はインクリメンタル評価を実行し、同じ図形で再度呼び出された場合には最初のステージのアルゴリズムを繰り返すことなく行うことができます。
この場合、この関数の最初の呼び出しは、2回目以降の呼び出しよりも時間がかかります。
関数は評価のタイプを示す値を返します。

- DCM\_FULL\_EVAL \- モデル全体に対して完全な評価が行われました。
- DCM\_PARTIALLY\_INCREMENTAL\_EVAL \- モデルの一部がインクリメンタルに評価されました。
- DCM\_FULLY\_INCREMENTAL\_EVAL \- モデル全体がインクリメンタルに評価されました。
- DCM\_EVAL\_ABORTED \- アプリケーションによって中止されました。

これにより、この関数の連続した呼び出しがシーケンスの一部でない場合、関数resetを呼び出す必要があります。
これにより、DCMのデータ構造が再初期化されます。
この関数の一連の呼び出しの最初の前に常にresetを呼び出すことが推奨されます。
変換と半径を変更することは、連続した呼び出しの間にのみ可能です。
他の引数を変更すると、これによりDCMが自動的に再初期化されます。

この関数の連続した呼び出しの各解は、前の解に対して相対的に見つかります。
これは、単一のステップでは見つからない解を複数のステップで達成できる可能性のある特定のタイプのモデルで利点となります。
したがって、これらのタイプのモデルでは、見つかった解はステップサイズに影響を受けます。

ドラッグのための可能なアルゴリズムは次のとおりです。

ドラッグする図形を選択する

変換を割り当てる

resetを呼び出す

ドラッグ中である間

元の位置に対する変換を設定する

dynamic\_evaluateを呼び出す（Frustumを通じて変換の出力を無視する）

ドラッグが成功した場合

すべての図形に対して

transformを呼び出して最後の変換を問い合わせる

変換が単位行列でない場合

アプリケーション内の図形を更新する

そうでなければ

undo\_evaluation(UNDO\_TO\_PREVIOUS)を呼び出す
