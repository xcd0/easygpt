## 8.6 スプライン解決の挙動の制御

DCMは、アプリケーションがスプラインの挙動を制御するための柔軟性を提供する低レベルのスプラインジオメトリインターフェースを提供します。
アプリケーションは、適切なDCM関数を実装し、いくつかの追加機能を提供することで、さまざまな機能を実装することができます。
このセクションでは、その可能性の一部を説明しますが、すべての機能はAnalyseテストプログラムで実装されています。

### 8.6.1 制御点と補間点の依存関係

このセクションは、補間スプラインのみに適用されます。つまり、アプリケーションが制御点データでスプラインを定義しない場合です。

一般的に、スプラインが解決されると、DCMは制御点の変更を最小限に抑えようとします。これが制御点の依存性です。制御点で定義されていない補間スプライン（データマスク要素DCM\_BS\_CP\_Nが定義されていない）の場合、アプリケーションは解決中に補間点の変更を最小限に抑えることを望む場合があります。つまり、補間点の依存性です。

どの解決動作が優先されるかは、アプリケーションによって決定されます。スプラインが作成または更新される際に、DCM\_bs\_dependenceタイプを使用してスプラインの依存性が設定されます。それはDCM\_BS\_DEPENDENCE\_CPまたはDCM\_BS\_DEPENDENCE\_INTERPのいずれかです。

補間点の依存性では、補間点は作成された位置または移動先のままになる傾向があります。これは、補間点をスプラインの形状を編集する主な手段としてユーザーに表示するアプリケーションに適しているでしょう。制御点の依存性では、制御点は初期位置に留まる傾向があります。

補間点の依存性の欠点は、新しい制約を満たすために単一の補間点のみを移動することはできず、全体の曲線の形状にいくらかの変更が加わることです。制御点の依存性では、曲線の形状の変更は変更された制御点の領域に制限されることができます。

### 8.6.2 補間スプラインの再パラメータ化

デフォルトでは、補間条件を満たすスプラインを解く際に、アプリケーションは補間条件が作用するパラメータの値を変更することがあります。
補間条件が固定されたパラメータ値のままである場合、望ましくない曲線の形状の影響が生じることがあります。
特に、隣接する2つの補間点が近づけられると、曲線は点の間にループや膨らみを形成する傾向があります。

この問題は、再パラメータ化によって対処することができます。再パラメータ化は、任意のパラメータ化スキームに対してアプリケーションによって外部で実装されるか、またはDCMによって内部的にコード長パラメータ化のために実装されます。
再パラメータ化により、例えばスプライン上の補間点をドラッグすることで（パラメータ化を連続的に変更することで）、他の補間点は移動しません。
補間点の依存性を持つスプラインのみが、そのパラメータ化を変更することができます。

スプラインデータのパラメータ化フィールドがDCM\_BS\_PARAMETERISATION\_VARIABLE（デフォルトのDCMの動作）に設定されている場合、アプリケーションはDCMがFrustum関数DCM\_spline\_updateを呼び出すことで形状を変更するたびに、スプラインのパラメータ化を変更する機会を与えられます。
アプリケーションは任意のパラメータ化を使用することができます。例えば、重心パラメータ化です。
アプリケーションは、DCMから供給される新しい補間点の位置に基づいて、スプラインのパラメータ化を再計算する必要があります。
これは通常、モデルが評価されるたびに何度も行われます。
なお、曲線の開始および終了パラメータは変更できません。

もし望ましい動的再パラメータ化スキームがコード長パラメータ化である場合、アプリケーションはスプラインのパラメータ化フィールドをDCM\_BS\_PARAMETERISATION\_CHORD\_LENGTHに設定することで、DCMに必要に応じてスプラインの自動再パラメータ化を行わせることができます。
同様に、望ましい再パラメータ化が重心パラメータ化である場合、アプリケーションはDCM\_BS\_PARAMETERISATION\_CENTRIPETALに設定することで、DCMにスプラインの自動再パラメータ化を行わせることができます。

コード長パラメータ化とは、補間点の正規化パラメータ値が、その点までのコード長の正規化合計と等しくなるように定義されることを意味します（コードは補間点間の直線セグメントです）。
このスキームでは、DCMは補間点とその補間条件について、この定義が常に適用されるように注意を払います。
隣接する2つの補間点の間に適用される補間条件は、パラメータ空間での線形補間を使用して、スプラインの総コード長に対する2つの補間点間の距離の比を保持するように新しいパラメータ値が与えられます。
例えば、隣接する2つの補間点のパラメータ値が0.1と0.3から0.15と0.4に変更された場合、元々0.2で適用されていた補間条件は、0.275で中間に位置するように再配置されます。言い換えれば、補間点間の各パラメータ間隔は、その2つのエンドポイント間の直線距離がスプラインの総コード長に対して成長または縮小するかに応じて一様に伸縮されます。

重心パラメータ化の動作は同じですが、パラメータは重心法に従って計算され、補間点間の異なるスプライン曲線が生成されます。
スプラインに重心パラメータ化を使用するアプリケーションは、DCMの自動パラメータ生成を使用することで効率を向上させることができます。

自動コード長または重心パラメータ化の場合、以下の条件を満たさない場合、add\_spline\_g、update\_spline、またはreplace\_splineの呼び出しは失敗し、DCM\_BS\_STATUS\_BAD\_DATAを返します。

- スプラインは補間スプラインであり、補間依存性（DCM\_BS\_DEPENDENCE\_INTERP）を持つ必要があります。
- スプラインには、最大および最小パラメータ値での補間点がある必要があります。つまり、DCM\_BS\_ITYPE\_COIまたはDCM\_BS\_ITYPE\_G\_COI条件が適用されている必要があります。

コード長パラメータ化の元の動作は、DCMがevaluateなどの呼び出し中にのみパラメータを更新するというものでした。
アプリケーションは任意のパラメータ化を使用して補間条件を追加することができ、これらはevaluate中にのみコード長パラメータに変換されます。
これは、スプラインが作成された直後やupdate\_splineが呼び出された直後に問い合わせ関数を使用してパラメータを問い合わせると、望ましいコード長パラメータではなく古いパラメータが返されることを意味します。
これはバージョン70から変更され、作成時およびupdate\_spline呼び出し後にパラメータを更新するようになりました。
従来の動作は、DCM\_BS\_PARAMETERISATION\_CHORD\_LENGTH\_69を使用することで復元することができます。

### 8.6.3 曲線の形状を変えずに新しい補間条件を挿入する

一部の場合、現在の測定値が与えられているにもかかわらず、新しい補間条件を追加すると、曲線の形状が変わることがあります。
これは、補間条件を許容するために、曲線の複雑さ（つまり、制御点の数）を増やさなければならないためです。
このような場合、アプリケーションは制御点を再配置し、ノットベクトルを変更することで、曲線の形状の変化を防ぐことができます。

解析テストプログラムでは、スイッチ「スプライン... 条件... 自動ノット挿入」を実装して、この動作を有効にすることができます。
このモードが有効になると、解析は補間条件が追加された場合でも、元の形状を維持するために必要な制御点の位置とノットベクトルを計算します。
この機能は、「The NURBS Book」の第5章で示されているノット挿入アルゴリズムを使用しています。
このアルゴリズムでは、新しい制御点を指定して既存の制御点の位置をいくつか変更することで、スプライン曲線に新しい制御点を挿入する際に曲線の形状を変えずにする方法が指定されています。

このアプローチを実装するために、アプリケーションは開始時の制御点の位置とノットベクトルを決定する必要があります。
この情報はDCMから問い合わせることができます。
次に、アプリケーションは新しい制御点ベクトルとノットベクトルを計算し、これらをスプラインの更新時にDCMに提供する必要があります。
アプリケーションが以前にノットベクトルを提供していなかった場合、この時点からノットベクトルの提供を開始し、このスプラインに対して継続する必要があります。

DCM関数: [update\_spline](16.6._Spline_functions.md)

### 8.6.4 スプライン曲線への自由度の追加

アプリケーションがモデルの利用可能な自由度を制限せずにスプラインに新しい補間条件を追加したい場合、作成のみの期間での補間条件の作成が使用されます。
他の補間条件と同様に、これによりDCMは条件を適用できるように曲線に追加の複雑さをもたらします。

作成のみの期間を持つ補間条件は、DCMが初期のスプライン形状を生成するためにのみ使用されます。
評価中には保持されません。
ただし、評価後にアプリケーションがその条件の現在の値をenquire_splineを介して読み取ることが可能です。

作成のみの補間条件は、ユーザーが曲線の形状を変更せずにスプラインに新しい制約を適用したい場合に、アプリケーションによって使用されることがあります。
適切なタイプと値の作成のみの補間条件を制約とともに追加することで、曲線が形状を変えずに制約を満たすために十分な自由度を持つことが保証されます。
例えば、直線に接線を適用する場合、アプリケーションは作成のみの期間を持つ補間DCM_BS_ITYPE_DERIV1条件を追加して曲線を事前に配置することができます。

### 8.6.5 スプライン曲線から自由度を削除する

スプライン曲線がDCMに追加された後、その形状と位置を完全に定義するために、次の方法が利用できます。

- スプライン曲線は固定され、すべての自由度が削除されます。
- スプライン曲線の剛性プロパティを使用して、内部のスプラインの自由度を削除することができます。
スプラインの剛性は次のように設定できます：

- DCM\_BS\_RIGIDITY\_RIGID - 剛体の自由度のみを持つ剛性スプラインを作成します。
- DCM\_BS\_RIGIDITY\_SCALABLE - サイズのための単一の内部自由度を含む剛体の自由度を持つスケーラブルなスプラインを作成します。
- DCM\_BS\_RIGIDITY\_UNI\_SCALABLE - 単一の方向のスケーリング自由度を持つ剛体の自由度を持つ単一スケーラブルスプラインを作成します。
- DCM\_BS\_RIGIDITY\_BI\_SCALABLE - 単一の方向によって定義される互いに直交する2つの独立したスケーリング自由度を持つ剛体の自由度を持つバイスケーラブルスプラインを作成します。

単一またはバイスケーラブルスプライン曲線を設定する場合、アプリケーションはupdate\_spline関数を介してスケーリング方向を指定する必要があります。
スケール方向はスプライン曲線に対して固定され、スプライン曲線の回転の結果としてのみDCMによって変更されます。
この場合、同じ回転がスケール方向に適用されます。
詳細については、[16.6.1 DCM\_bs\_data - スプラインデータ構造](16.6._Spline_functions.md)を参照してください。
デフォルトでは、DCMは常に単一スケーラブルスプラインに正のスケーリング係数を適用します。

同じDCMインスタンス内のすべてのこのような曲線に負のスケーリングを許可するために、DCM\_OPKEY\_UNI\_SCALABLE\_NEGATIVE\_SCALING（単一スケーラブルの場合）またはDCM\_OPKEY\_BI\_SCALABLE\_NEGATIVE\_SCALING\_1および/またはDCM\_OPKEY\_BI\_SCALABLE\_NEGATIVE\_SCALING\_2（バイスケーラブルの場合）のいずれかをDCM\_OPVAL\_ONに設定することが可能です。
DCMはスケーリング係数0を正確に適用しません。

![](../Resources/Images/2ddcm_manual/Controlling spline solving.jpg)

図55：水平方向のスケーリング方向を持つ単一スケーラブルスプライン

- DCM\_BS\_RIGIDITY\_FLEXIBLE - 制御点の数、合理性、周期性などに依存する自由度を持つ柔軟なスプラインを作成します。

- DCMの拘束。
ほとんどのDCMの寸法と拘束はスプライン曲線に適用することができます。
詳細については、[7.2 パラメトリック曲線の寸法と拘束](7.2._Dimensions_and_constraints_to_parametric_curves.md)を参照してください。
- 補間条件。
DCMの解決中に適用される補間条件（つまり、常にの期間 - DCM\_BS\_INTERP\_DURATION\_ALWAYS）は、曲線から自由度を削除します。
詳細については、[16.6.2 補間条件の種類](16.6._Spline_functions.md)を参照してください。

8.6.6 拘束を評価せずに補間条件を解決する

DCMは、スプラインの形状を2つの異なる方法で計算します。

- スプラインが追加された直後、またはupdate\_splineを呼び出して定義が変更された直後に、DCMによってスプラインの形状が更新されます。
補間条件が満たされる場合、その期間に応じて更新されます。
スプラインに対する拘束や寸法は考慮されず、結果の曲線がこれらを満たしていない場合があります。
これはスプラインのリフレッシュと呼ばれます。
- モデルがDCMのevaluate、re\_evaluate、move\_and\_evaluate、dynamic\_evaluate関数によって評価されると、スプラインの形状も計算されます。
補間条件に一致するようにスプラインの形状を調整するだけでなく、他の図形と同様にスプラインへの拘束も解決し、満たすことができない場合はステータスコードを与えます。

DCMは、パラメータに基づいて曲線の位置を問い合わせるためのスプライン評価関数を提供しています（詳細は[8.7 DCMスプライン評価関数の呼び出し](8.7._Calling_the_DCM_spline_evaluators.md)を参照）。

補間条件のリフレッシュのみの期間オプションは、アプリケーションがDCMにスプラインをリフレッシュするように要求する場合にのみ適用される補間条件を指定するためのメカニズムを提供します（つまり、evaluate、re\_evaluate、move\_and\_evaluate、dynamic\_evaluate以外のDCMの拘束ソルバー関数）。

補間条件のリフレッシュのみの期間を使用することで、モデルが評価される際にスプライン曲線を過剰に定義する条件を追加することができます。
その後、update\_spline関数を呼び出して曲線の形状をリフレッシュすることで、DCMを使用してこれらの条件を適用し、指定された補間条件にスナップさせることができます。

### 8.6.7 スプラインの編集

DCMスプライン曲線の形状を変更するためには、さまざまな方法が利用できます。
どの方法が適切かは、曲線をどのように変更するかによって異なります。

- dynamic\_evaluateを使用して制御点または補間点をドラッグする方法。

DCMモデル内の点である制御点または補間点を作成してスプラインを定義した場合、dynamic\_evaluate関数を使用して曲線の点を動的に再配置することができます。
この方法は、単一の点をドラッグしたり、各点に対して変換を指定して複数の点を一緒に移動するために使用することができます。

- update\_spline関数を介して。

この方法は、ほとんどのスプラインデータを変更することができるため、最も制御が可能です。
この方法は、新しい補間条件の追加など、一度だけの変更が必要な場合に有用です。
また、ユーザーが値を変更し、特定の新しい値を使用することを知っている場合にも適しています。
ただし、次の制約があります。

- update\_splineはDCMモデルをリセットし、次回の評価時に完全な評価を強制します。
- アプリケーションは、データマスクからビットを削除してはなりません。
つまり、スプラインデータ構造の特定の要素がスプラインのためにDCMに提供された場合、それは常に後続の更新に適用されます。
したがって、例えば制御点スプラインを補間スプラインに変換することはできません。
DCMは、以前に提供された制御点の数と制御点の値が引き続き適用されると想定します。
- この方法を使用する別のオプションは、スプラインデータに対してNULLを返すことです。これにより、DCMに対して一部の制御点または補間点が変更されたことを示すことができます。
これにより、DCMはFrustumを介して点の新しい位置を問い合わせます。
これは、アプリケーションがDCMの評価を実行せずにスプラインの形状を更新したい場合に便利です。
update\_splineがNULLスプラインデータで呼び出されると、DCMはリセットされません。

- DCM\_spline\_update Frustumを介して評価中に。

この方法は、DCMのリセットを引き起こさないため、move\_and\_evaluateやdynamic\_evaluateと共に使用することができるため、動的な変更に最適です。
典型的な使用例は、ユーザーが画面上でスプラインを動的に更新しながら、補間条件を表すシンボルをドラッグできるようにすることです。
たとえば、矢印の端点を移動することで接線の方向を変えることができます。
各ステップでは、アプリケーションは矢印シンボルの方向を決定し、re\_evaluateを呼び出して補間条件の値を新しい方向に更新することができます。

このアプローチの制約は、特定のスプラインプロパティのみが更新可能であるということです。
次のプロパティは、スプラインに対して指定されている場合に変更できます：制御点の重みと補間条件ベクトル。

剛体または固定スプラインの場合、move\_and\_evaluate関数中にDCM\_spline\_updateを使用してより基本的な変更を行うことも可能です。
可能な変更の詳細については、[17.4.1 DCM\_spline\_update – スプラインプロパティの更新を許可する](17.4._Functions_for_spline_curves.md)に記載されています。
