## 13.1 自動拘束

DCMは、アプリケーションが図形に自動的に拘束を適用するためのサポートを提供します。
これは、図形データが拘束情報なしでアプリケーションに読み込まれる場合に必要とされることが多いです。
また、既存の図形に対して新しい図形を作成する際にも、既存の図形に対して拘束を生成する必要があります。

アプリケーションがDCMに対して拘束を検索するよう要求する際、線形許容差、角度許容差、および検索する拘束の種類をDCMに提供します。
アプリケーションは、必要なものを指定するために、ジオメトリのリストをDCMにオプションで提供することもできます。
これらのリストは、次のいずれかを指定できます。

- 指定された領域、またはモデル全体に拘束されるべきジオメトリまたはセット。
- 拘束するモデルの領域。
- 拘束するための優先されるジオメトリのリスト（例：参照軸）。
- 平行および直角拘束を適用する際に考慮する方向付きジオメトリの種類。
- 対称拘束の軸として使用する直線のリスト。
- 等距離拘束に使用するジオメトリのペア。

さらに、アプリケーションは次のオプションを使用して次の操作を行うことができます。

- 自動拘束に使用する解決モードを選択する。
- ジオメトリが移動しすぎる場合に、内部的に拘束を拒否するために使用される追加の角度および線形移動許容差を提供する。
通常、この機能は必要ありません。

このオプションは、個々に線形および角度許容差を満たすジオメトリのチェーンで最も有用ですが、特定のジオメトリが解決時により大きな距離や角度で移動する場合に使用されます。
詳細については、セクション[13.1.3.2 モデル内の移動を回避するための拘束のブロック](#_Ref428534320)を参照してください。

DCMは、ジオメトリの位置とアプリケーションによって指定された解像度に基づいて拘束を見つけます。
既にモデルに適用されている拘束と寸法を考慮に入れるため、モデルが過定義になるような拘束は見つかりません。
これは、セクション[13.3 拘束の推論](13.3._Constraint_deduction.md)で説明されている関数とは異なる動作です。
自動拘束の正確な機能は、次のDCMオプションによって変更することができます。

- DCM\_OPKEY\_AUTOCON\_HELP\_POINTS - DCMが曲線の拘束にヘルプポイントを提供するかどうかを決定します。
提供される場合、アプリケーションはそれらを使用する必要があるため、アプリケーションがヘルプポイントを使用しない場合はこのオプションをOFFに設定し、使用する場合はONに設定する必要があります。
- DCM\_OPKEY\_AUTOCON\_CONSTRAINTS - DCMが可能な限り最大数の拘束を提供するか、DCM\_OPVAL\_AUTOCON\_MAX\_CONSTRAINTSの値を使用してすべての潜在的な関係を表す十分な拘束を提供するかを決定します。
- DCM\_OPKEY\_AUTOCON\_V49 - 2D DCMがバージョン49と同じ方法で自動拘束アルゴリズムを使用するかどうかを決定します。
デフォルトは、新しい、はるかに効率的なアルゴリズムを使用することですが、同じ結果が必要な顧客は、古いモデルのためにこのオプションを使用することを希望するかもしれません。
- DCM\_OPKEY\_VER\_AUTOCON\_EQUIV\_CLASS - DCMが使用する自動拘束アルゴリズムのバージョンを決定します。
デフォルト値はDCM\_OPVAL\_VER\_AUTOCON\_EQUIV\_CLASS\_CURRENTであり、最新バージョンのアルゴリズムが使用されることを保証します。

DCM\_OPVAL\_VER\_AUTOCON\_EQUIV\_CLASS\_67の値を使用すると、自動拘束アルゴリズムは出力の同値クラスに対して、各メンバーが指定された許容差以下で他のすべてのメンバーと関連していることを保証します。
古い動作であるDCM\_OPVAL\_VER\_AUTOCON\_EQUIV\_CLASS\_66では、指定された許容差を超えるクラスが作成されることがありました（詳細については、[13.1.2 同じ同値クラスのメンバー間の関係](#_Ref475984954)を参照）。
以前のバージョンと同じ結果が必要なアプリケーションには、オプションDCM\_OPVAL\_VER\_AUTOCON\_EQUIV\_CLASS\_66を使用することで後方互換性が提供されます。

フラスタム関数DCM\_autocon\_weightは、ユーザーに制約の選択に対する追加の制御を提供します。
これは、エンドユーザーが選択基準に基づいて重みを返し、制約がモデルにどのように適用されるべきかをバイアスするものです。
負の重みは「適用しない」という意味であり、正の重みは制約の優先度を示します。
重みが大きい制約は、自動拘束中に早く適用され、優先度の低い制約を置き換える可能性があります。

DCMは、モデルに拘束を適用しません。
代わりに、アプリケーションに2つの形式で情報を返します。

- 同値クラス。
情報の量を減らすために、DCMは同一、平行、同心、等半径、等距離の拘束のためのジオメトリのリストを出力します。
詳細については、セクション[13.1.1 同値クラス](#_Ref497197429)を参照してください。
- 特定の拘束。
その他のすべての拘束は個別に出力されます。

DCMが提案する拘束が出力された場合、それらはアプリケーションによって適用されることが期待されています（add\_dを呼び出すこと）。
フラスタム関数が呼び出される際にそれを追加しないことで、提案された拘束を拒否することも可能です。
その場合、DCMは代替の拘束を提案します。
ただし、DCM\_autocon\_weight関数に負の重みを指定することで、DCMが不要な拘束を出力しないようにする方が効率的です。

注意：

- パターン、等相対変換、中点の拘束は現在サポートされていません。
- パラメトリックへの拘束は、曲線がグローバルにC1連続である場合にのみ見つかります。
- 同じセット内の要素間での拘束は識別されません。
- DCMは、同値クラスとして出力される拘束の重みを問い合わせません。

DCM関数：[autoconstrain](16.11._Autodimensioning_and_autoconstraining.md)

フラスタム関数：[DCM\_automatic\_class](17.10._Functions_for_constraint_deduction_and_autodimensioning.md)

### 13.1.1 同値クラス

同値クラスとは、ある幾何学的な関係を満たす図形の集合です。
DCMは、同一、平行、同心、半径が等しい、距離が等しいの5つのタイプの同値クラスを認識します。
DCMは、制約を検索する際に、同値クラス内のすべての図形のリストを出力します。
ただし、クラスのメンバー間の具体的な制約は出力しません。

なお、同一の同値クラスには、同じタイプかつ同じ位置にある図形が含まれ、一致制約として出力されます。
その他の同値クラスは、DCMがサポートする特定の制約に対応します。

同値クラスは、DCMが出力する情報量を減らします。
例えば、2つの直線が同一である場合（つまり、同じ同値クラスにある場合）、それらは同じ平行な同値クラスにも属します。
ただし、DCMが平行な同値クラスを推論する際には、そのうちの1つのみがDCMによって参照されます。
同様に、2つの平行な同値クラスのそれぞれに複数の直線がある場合（[図64：2つの平行な同値クラスの例](#_Ref497282245)のような場合）、単一の垂直制約のみが出力されます。

![fig56_equivalence.bmp](../Resources/Images/2ddcm_manual/Autoconstraining.png)

図64：2つの平行な同値クラスの例

同一の同値クラスは、他の同値クラスおよび具体的な制約の出力に影響を与えます。
平行な同値クラスは、垂直制約の出力に影響を与えます。
いずれの場合も、DCMは同値クラスの代表的なメンバーを選択して制約を出力します。

アプリケーションは、同値クラスのメンバー間や同値クラス間の制約の配置方法を自由に選択することができます。
実際に、DCMは過拘束であるが整合した構成を無視するため、可能な制約をすべて図形に配置することができます。

なお、剛体セットを含むモデルでは、1つの同値クラスには最大で1つの図形が含まれます。

フラスタム関数：[DCM\_automatic\_class](17.10._Functions_for_constraint_deduction_and_autodimensioning.md)

### 13.1.2 同じ等価クラスのメンバー間の関係

現在の自動拘束アルゴリズム（バージョン67）を使用すると、DCMは適用される制約が指定された許容範囲内の図形間にあることを保証します。距離または角度によって指定された許容範囲内でのみ制約が適用されます。
バージョン66を使用すると、適用された制約のチェーンによって、許容範囲を超えて分離された2つ以上の図形が制約される可能性があります。

[図65 自動拘束における等価クラスの出力の例](#_Ref476134846)は、自動拘束が同一の等価クラスを見つけ、それに基づいて一致する制約を自動的に適用するために使用される例を示しています。
この例では、同一の幾何学的形状を探す際に自動拘束によって一致するようにできる4つの点があります。各ペア間の距離が表示されています。

たとえば、線形許容範囲が5.5単位の場合、最初にその許容範囲内にある4つの点のペアがありますが、これらは単一の等価クラスの一部にはなりません。なぜなら、対角線の距離が許容範囲を超えているからです。囲まれた点のペアは、全体的な許容範囲を尊重しながら、最も密集している点を選択してDCMが識別する2つのクラスを示しています。

![](../Resources/Images/2ddcm_manual/Autoconstraining_1.png)

図65 自動拘束における等価クラスの出力の例

比較のために、古いバージョン66のアルゴリズムでは、DCMは点1、2、および4を単一のクラスに配置し（点3を制約しない）、クラスに追加される各図形が最初のクラスメンバーとの許容範囲内にあることだけを要求しました。

### 13.1.3 自動拘束

アプリケーションは、autoconstrain関数を使用する際に以下のポイントを考慮する必要があります。

- デフォルトでは、autoconstrainは曲線の図形に対して拘束のためのヘルプポイントを提供します。
ヘルプポイントの値が提供された場合、アプリケーションはそれを使用する必要があります。
ヘルプポイントを使用しないアプリケーションは、DCMオプションDCM\_OPKEY\_AUTOCON\_HELP\_POINTSをOFFに設定する必要があります（詳細はセクション[16.2.5.1 解析的な曲線図形に対する自動拘束のためのヘルプポイントの位置を返す](16.2._Configure_global_DCM_behaviour.md)を参照）。
- デフォルトでは、autoconstrainは、すべての関係を完全に定義するために追加する必要のある拘束の数を最小限にするように設計されています。
これは、他の拘束や既にモデルに存在する寸法によって拘束が既に暗黙的に示されている場合、図形間の拘束を提案しないことを意味します。

この動作を変更して、モデルが過剰に定義されていない制約の最大数を特定できるようにすることができます。
ただし、モデルは過拘束になります。
たとえば、四角形のすべての角に直角の拘束を強制するには、DCMに制約の最大数を返すように要求する必要があります。

この動作を制御するために、アプリケーションはDCM\_OPKEY\_AUTOCON\_CONSTRAINTSオプションのset\_option関数を使用する必要があります。値はDCM\_OPVAL\_AUTOCON\_MIN\_CONSTRAINTS（デフォルト）またはDCM\_OPVAL\_AUTOCON\_MAX\_CONSTRAINTSです。
注：このオプションは、同等クラスで特定される図形の数には影響しません。DCMは常に相互に平行な直線の完全なセットをリストします。

- DCMは、非境界の図形間の拘束を見つけることができます。
ただし、アプリケーションは、図形の境界部分に対する拘束にのみ興味がある場合があります。
たとえば、DCMは直線と円の接線を見つけるかもしれませんが、アプリケーションは円弧の境界部分に対する接線のみを求めると決定するかもしれません。
- DCMは、アプリケーションがDCMが推奨するすべての拘束を追加する場合に最適化されています。
多くの拘束を拒否すると、アルゴリズムが遅くなる可能性があります。
可能な限り、DCM\_autocon\_weight Frustum関数を使用して、ペアの図形間の不要な拘束をフィルタリングする必要があります。なぜなら、この時点で拘束を拒否すること（負の重みを与えること）はコストがかからないからです。
- 同等クラスによって出力される拘束は、重みを使用してランク付けすることはできません（これらの拘束に対してはDCM\_autocon\_weightは呼び出されません）。これらは常に非同等の拘束よりも優先されます。
なお、DCM\_automatic\_class内で必要な拘束よりも少ない数の拘束を適用することが可能です。つまり、拘束を追加する際に、アプリケーションは同等クラスを分割したり、拘束を適用しないことが許可されています。
- 大きなモデルでは、多くの可能な拘束が存在する場合があります。
これらのうちの多くは破棄されますが、それぞれを確認する必要があります。
- autoconstrain関数は図形を移動しません。
したがって、関数が呼び出されたときに指定された解像度に従って拘束が適用されているかもしれませんが、それらはDCMの精度で満たされていないかもしれません。
autoconstrainを呼び出した後、アプリケーションはモデルを評価することを推奨します。
- 等距離の拘束は、関数に渡される適切な図形のペア間にのみ適用されます。
通常、これらのペアは直線の端点を表す場合（この場合、DCMは直線の長さを同じにするように拘束しようとします）または2つのオフセットプロファイルの図形のペアです。

#### 13.1.3.1 自動拘束時に考慮する方向付き図形の選択

[3.2 図形の分類](3.2._Classification_of_geometry.md)のセクションで文書化されているように、DCMは自動拘束中にこれらの図形タイプに対して平行または直角の拘束を推論することができます。

autoconstrain関数のオプションを使用して、どのタイプの方向付き図形を考慮するかを制御することができます。
これを使用するには、アプリケーションはDCM_AUTOCON_VERSION_2オプションを使用し、拘束する方向付き図形のビットマスクを設定する必要があります。
[16.11.1 autoconstrain - 自動的に拘束を生成する](16.11._Autodimensioning_and_autoconstraining.md)を参照してください。

#### 13.1.3.2 モデル内の移動を防ぐためのブロッキング制約

autoconstrainは、解決に使用される解像度値とは別の許容範囲を使用して制約を追加するため、ジオメトリが新たに追加された制約を解決するために移動する必要がある可能性があります。
もちろん、使用される許容範囲値がDCMの解像度よりも大きい場合、ジオメトリが移動する必要がある可能性が高くなります。
DCMのautoconstrainはジオメトリを移動させません（つまり、変換を出力しませんが、プロセス中にパラメトリックジオメトリが一時的に異なる位置に再生成される場合があります）。
したがって、追加された制約は、autoconstrain関数の最後に満たされない場合があります。
また、アプリケーションによって最初に追加された満たされていない制約があるモデルに対してautoconstrainを呼び出すことも可能です。

通常、移動の予想される量は、入力許容範囲のサイズのオーダーになります（最初に満たされたモデルを仮定しています）。
ただし、乗算効果により、ジオメトリが大幅に移動することがあります。
候補制約を見つけるために使用される許容範囲値と大きな移動が引き起こされる可能性との間には、直接的な関係はありません。

次に評価される解決モードは、大きな移動が発生する可能性に影響を与えます。たとえば、通常の解決に比べて、最小移動解決は大きな移動の可能性が少ない場合があります。

[図66：Autoconstrainの線形および角度移動許容範囲](#_Ref428546796)は、線形および角度移動許容範囲の使用例を示しています。
ポイント間の距離が線形許容範囲未満であるか、または線の間の角度が角度許容範囲未満である場合、autoconstrainは前者のポイント間の一致制約と後者の線の間の平行制約を識別します。
ただし、これらの制約が適用されると、距離または角度が蓄積され、特定のジオメトリが制約を満たすためにはるかに大きな距離または角度で移動する可能性があります。

![](../Resources/Images/2ddcm_manual/Autoconstraining.jpg)![](../Resources/Images/2ddcm_manual/Autoconstraining_1.jpg)

図66：Autoconstrainの線形および角度移動許容範囲

したがって、autoconstrain関数は制約解析中のジオメトリの移動をチェックするためのオプションモードを提供します。
これには、候補制約の検出のための許容範囲よりも大きい許容範囲が必要です（小さい値に設定するよりも効率的ではないため、推奨されません）。

移動をチェックする際、基本的な無限ジオメトリを単純にチェックする代わりに、DCMはアプリケーションが興味を持つ変更のみを考慮するための一連のヒューリスティックを使用します。
将来的には、異なる「レベル」のチェックの下で別のヒューリスティックを追加する余地があります。

現在のヒューリスティックは、境界付きの直線、円弧、楕円形のエッジが制約を超えて移動するかどうかを特定しようとします。
これは、たとえば、円の中心が制限を超えて移動することが許容される場合、円の境界付きの円弧自体があまりにも移動しない場合です。
円弧は通常、円のごく一部に制限され、円弧のわずかな変化が円の中心に非常に大きな変換を与えます。

次のテストが使用されます：

- 線形許容範囲を超えてポイントが移動しない（円の中心ポイントを除く）。

- 円または楕円の中心は、円の中心と同じように定義され、他のジオメトリに制約されていない点と同一です。
したがって、円またはそれに同心の点と重なることがあります。

- 直線の場合、境界付きの直線エッジを表すかどうかを特定しようとします。

- 2つ以上の異なる点が直線に重なる場合、境界付きのエッジが推定されます。
境界付きの直線は、境界点があまりにも移動する場合にのみ、あまりにも遠くに移動すると見なされます。
- 境界のない直線は、角度の変化が指定された角度移動許容範囲を超えるか、位置が線形許容範囲を超えるかどうかをチェックします。

- 円弧と楕円の場合、境界付きのエッジを表すかどうかを特定しようとします。

- 円/楕円に2つ以上の異なる点が重なる場合、境界付きのエッジが推定されます。
その場合、autoconstrainは、潜在的な境界付きエッジ上のすべての位置が線形許容範囲未満で移動する場合、円の変換を許可します。
境界付き円弧の条件が満たされない場合、ジオメトリの任意の部分、その中心を含む、が線形許容範囲を超えて移動すると、制約は拒否されます。

- スプラインは、任意の位置が線形許容範囲を超えて移動するかどうかをチェックします。
- 評価されたパラメトリック曲線と円錐曲線は現在チェックされていません（定義ジオメトリのチェックを除く）。

### 13.1.4 解析ユーザーインターフェースでの自動拘束

「自動拘束」メニューには、DCMの自動拘束機能を使用して図形に拘束を適用するコマンドがあります。
このメニューのコマンドを使用すると、ユーザーは選択的な拘束を適用したり、次のセクションで説明されている定義済みの順序で拘束を適用したりすることができます。

#### 13.1.4.1 モデルシーケンスの自動拘束

解析コマンドAutoconstrain modelは、拘束を自動的に追加する方法の例として提供されています。
autoconstrain関数を呼び出すと、Autoconstrain modelコマンドは、指定された優先ジオメトリと対称軸のリストを使用します。
一部の拘束タイプでは、ジオメトリの境界領域内で見つからない場合は、拘束を追加しません。
追加される拘束の順序は次のとおりです。

- すべてのモデルジオメトリに対して：

- 同一性、対称性、同心円、平行、直交、等しい半径、等しい距離

- ジオメトリの境界領域に許可される一致の制限：

- 一致
- 各プロファイル（ポリライン）ごとに - 接線の拘束
- モデル全体に対するその他の接線の拘束
- 法線の拘束

アプリケーションは、適切な手順を見つけるために、典型的なモデルデータで実験することをお勧めします。

#### 13.1.4.2 スケッチ中の拘束の適用

アプリケーションが自動的に拘束を適用する別の方法は、スケッチ中にジオメトリにそれらを追加することです。
Analyseには、ユーザーがこれを行い、検索する拘束のタイプを設定するためのコマンドが含まれています。
ジオメトリが入力されると、指定されたタイプの拘束がカーソルが移動するたびに検索されます。

Analyseは、拘束が特定の許容範囲内で満たされているかどうかをチェックします。
許容範囲は、コマンド「グラフィックス機能... ピック半径」で変更できます。
見つかった拘束は、現在のピック半径よりも小さい値でカーソルを移動することで正確に満たすことができます。

Analyseには、拘束を推論するための2つのモードがあります。これは、トグル「ユーティリティ... スケッチオプション... 自動拘束スケッチ」がオンまたはオフになっているかによって異なります。
オフになっている場合（デフォルト）、次の拘束が見つかります：

- Make pointでポイントが作成されると、カーソルのピック半径内に既存のポイントがある場合、それらは一致するようになります。
- 他のポイントを作成するコマンド（例：Make line、Make circle）は、カーソルのピック半径内に既存のポイントがある場合、新しいポイントを作成しません。代わりに既存のポイントを再利用します。
- 他のコマンドでポイントが作成される場合、カーソルのピック半径内にポイントではない他のジオメトリがある場合、ポイントと他のジオメトリの間に一致する拘束が配置されます。
- ポイントが作成される場合、カーソルが2つの交差する曲線のピック半径内にある場合、ポイントは両方の曲線と一致するようになります。

トグル「ユーティリティ... スケッチオプション... 自動拘束スケッチ」がオンになっている場合、Autoconstrain options...メニューの他のコマンドが検索される拘束を制御します。
